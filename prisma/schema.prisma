// Main Prisma Schema - Platform Database
// For multi-tenant setup, we'll use this as the primary schema
// Tenant schemas will be managed dynamically

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Import platform schema models
// (In production, you'll manage tenant databases separately)

// ============================================
// PLATFORM OWNER & TEAM
// ============================================

model PlatformUser {
  id            String   @id @default(uuid())
  fullName      String   @map("full_name")
  email         String   @unique
  passwordHash  String   @map("password_hash")
  role          PlatformUserRole
  isActive      Boolean  @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  assignedTickets SupportTicket[] @relation("AssignedTickets")
  auditLogs       PlatformAuditLog[]

  @@map("platform_users")
}

enum PlatformUserRole {
  OWNER
  ADMIN
  SUPPORT
  SALES
  FINANCE
  DEVELOPER
}

// ============================================
// SCHOOLS (TENANTS)
// ============================================

model School {
  id                String   @id @default(uuid())
  schoolName        String   @map("school_name")
  subdomain         String   @unique
  customDomain      String?  @map("custom_domain")
  subscriptionPlanId String? @map("subscription_plan_id")
  status            SchoolStatus @default(TRIAL)
  trialEndsAt       DateTime? @map("trial_ends_at")
  
  adminName         String   @map("admin_name")
  adminEmail        String   @map("admin_email")
  adminPhone        String   @map("admin_phone")
  address           String?
  city              String?
  state             String?
  country           String   @default("India")
  pinCode           String?  @map("pin_code")
  
  logoUrl           String?  @map("logo_url")
  primaryColor      String   @default("#3B82F6") @map("primary_color")
  secondaryColor    String   @default("#10B981") @map("secondary_color")
  
  maxStudents       Int      @default(100) @map("max_students")
  maxTeachers       Int      @default(20) @map("max_teachers")
  maxStorageGb      Int      @default(5) @map("max_storage_gb")
  
  dbHost            String   @default("localhost") @map("db_host")
  dbName            String   @map("db_name")
  dbSchema          String   @default("public") @map("db_schema")
  
  // Module management
  enabledModules    Json?    @map("enabled_modules")
  
  // Tenant provisioning
  databaseName      String?  @map("database_name")
  databaseUrl       String?  @map("database_url")
  domain            String?
  contactEmail      String?  @map("contact_email")
  contactPhone      String?  @map("contact_phone")
  onboardedAt       DateTime? @map("onboarded_at")
  
  // Suspension tracking
  suspendedAt       DateTime? @map("suspended_at")
  suspensionReason  String?  @map("suspension_reason")
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  subscriptionPlan  SubscriptionPlan? @relation(fields: [subscriptionPlanId], references: [id])
  subscriptions     Subscription[]
  invoices          Invoice[]
  supportTickets    SupportTicket[]
  auditLogs         PlatformAuditLog[]

  @@map("schools")
}

enum SchoolStatus {
  ACTIVE
  TRIAL
  SUSPENDED
  CANCELLED
}

// ============================================
// SUBSCRIPTION PLANS
// ============================================

model SubscriptionPlan {
  id              String   @id @default(uuid())
  planName        String   @map("plan_name")
  planCode        String   @unique @map("plan_code")
  description     String?
  priceMonthly    Decimal  @map("price_monthly") @db.Decimal(10, 2)
  priceYearly     Decimal  @map("price_yearly") @db.Decimal(10, 2)
  
  maxStudents     Int      @map("max_students")
  maxTeachers     Int      @map("max_teachers")
  maxStorageGb    Int      @map("max_storage_gb")
  
  features        Json
  
  isActive        Boolean  @default(true) @map("is_active")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  
  schools         School[]
  subscriptions   Subscription[]

  @@map("subscription_plans")
}

// ============================================
// SUBSCRIPTIONS
// ============================================

model Subscription {
  id                    String   @id @default(uuid())
  schoolId              String   @map("school_id")
  planId                String   @map("plan_id")
  status                SubscriptionStatus @default(ACTIVE)
  billingCycle          BillingCycle @map("billing_cycle")
  currentPeriodStart    DateTime @map("current_period_start")
  currentPeriodEnd      DateTime @map("current_period_end")
  cancelAtPeriodEnd     Boolean  @default(false) @map("cancel_at_period_end")
  cancelledAt           DateTime? @map("cancelled_at")
  
  stripeSubscriptionId  String?  @map("stripe_subscription_id")
  razorpaySubscriptionId String? @map("razorpay_subscription_id")
  
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  
  school                School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  plan                  SubscriptionPlan @relation(fields: [planId], references: [id])

  @@map("subscriptions")
}

enum SubscriptionStatus {
  ACTIVE
  CANCELLED
  PAST_DUE
  EXPIRED
}

enum BillingCycle {
  MONTHLY
  YEARLY
}

// ============================================
// INVOICES
// ============================================

model Invoice {
  id                String   @id @default(uuid())
  schoolId          String   @map("school_id")
  invoiceNumber     String   @unique @map("invoice_number")
  amount            Decimal  @db.Decimal(10, 2)
  tax               Decimal  @default(0) @db.Decimal(10, 2)
  discount          Decimal  @default(0) @db.Decimal(10, 2)
  total             Decimal  @db.Decimal(10, 2)
  status            InvoiceStatus @default(DRAFT)
  dueDate           DateTime @map("due_date")
  paidAt            DateTime? @map("paid_at")
  
  paymentMethod     String?  @map("payment_method")
  paymentTransactionId String? @map("payment_transaction_id")
  
  description       String?
  items             Json?
  
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  SENT
  PAID
  OVERDUE
  CANCELLED
}

// ============================================
// SUPPORT TICKETS
// ============================================

model SupportTicket {
  id                String   @id @default(uuid())
  schoolId          String   @map("school_id")
  ticketNumber      String   @unique @map("ticket_number")
  subject           String
  description       String   @db.Text
  category          TicketCategory @default(GENERAL)
  priority          TicketPriority @default(MEDIUM)
  status            TicketStatus @default(OPEN)
  
  createdByUserId   String?  @map("created_by_user_id")
  createdByName     String   @map("created_by_name")
  createdByEmail    String   @map("created_by_email")
  
  assignedToUserId  String?  @map("assigned_to_user_id")
  
  messages          Json?
  attachments       Json?
  
  resolvedAt        DateTime? @map("resolved_at")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")
  
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  assignedTo        PlatformUser? @relation("AssignedTickets", fields: [assignedToUserId], references: [id])

  @@map("support_tickets")
}

enum TicketCategory {
  TECHNICAL
  BILLING
  FEATURE_REQUEST
  BUG
  GENERAL
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id            String   @id @default(uuid())
  settingKey    String   @unique @map("setting_key")
  settingValue  String   @db.Text @map("setting_value")
  description   String?
  category      String   @default("general")
  isEncrypted   Boolean  @default(false) @map("is_encrypted")
  updatedBy     String?  @map("updated_by")
  updatedAt     DateTime @updatedAt @map("updated_at")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("system_settings")
}

// ============================================
// AUDIT LOGS (Platform Level)
// ============================================

model PlatformAuditLog {
  id            String   @id @default(uuid())
  userId        String?  @map("user_id")
  schoolId      String?  @map("school_id")
  action        String
  resource      String?  // SCHOOL, SUBSCRIPTION, etc.
  resourceId    String?  @map("resource_id")
  details       Json?    // Additional details
  ipAddress     String?  @map("ip_address")
  userAgent     String?  @db.Text @map("user_agent")
  createdAt     DateTime @default(now()) @map("created_at")
  
  user          PlatformUser? @relation(fields: [userId], references: [id])
  school        School?   @relation(fields: [schoolId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([schoolId])
  @@index([action])
  @@index([createdAt])
  @@map("platform_audit_logs")
}
